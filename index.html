<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Gamedev Canvas Workshop</title>
    <style>
    	* { padding: 0; margin: 0; }
    	<!--canvas { background: -webkit-linear-gradient(top, #7db9e8 0%, #000000 45%, #000000 85%, #840000 100%); display: block; margin: 0 auto;}-->
		canvas {
			background-color: #000000;
			background: -webkit-linear-gradient(top, #840000 0%, #000000 25%, #000000 85%, #444444 100%);
			display: block;
			margin: 0 auto;
		}
    </style>
</head>
<body>

<canvas id="myCanvas" width="400" height="600"></canvas>
<hr>
<canvas id="myCanvas2" width="400" height="70"></canvas>
<script src="level_data.js">

</script>
<script>
	var level_refresh = 250;
	var blood_max = 10;
	var life = 3;
	var movespeed = 2;
	var SuperPower = 0;//normally it should be 0
	var ATKspeed = 2;//default 5
	var cycle = 12;
	var level = 0;//start level default 0
	/////////////////////////////
	var canvas = document.getElementById("myCanvas");
	var canvas2 = document.getElementById("myCanvas2");
	var ctx = canvas.getContext("2d");
	var ctx2 = canvas2.getContext("2d");
	var IcanFly={x : canvas.width/2,y :0, plane_w : 20};
	IcanFly.y=canvas.height-IcanFly.plane_w-10;
	var rightPressed = false;
	var leftPressed = false;
	var upPressed = false;
	var downPressed = false;
	var blood = blood_max;
	var level_ctr = 0;
	var level_text = "1-1";
	var posx=0;
	var boss_mode=0;
	var SuperPower_ctr = 0;
	var Bullets = [];
	Bullets[0] = [];
	Bullets[1] = [];
	var bullet_ctr = 0;
	var fire = false;
	var score = 0;
	var level_flag=0;
	var enemies = [];
	var pause=false;
	var boss_hurt = 0;
	document.addEventListener("keydown", keyDownHandler, false);
	document.addEventListener("keyup", keyUpHandler, false);
	
	function keyDownHandler(e) {
		if(e.keyCode == 39) rightPressed = true;
		else if(e.keyCode == 37) leftPressed = true;
		else if(e.keyCode == 38) upPressed = true;
		else if(e.keyCode == 40) downPressed = true;
		else if(e.keyCode == 32) fire = true;
	}

	function keyUpHandler(e) {
		if(e.keyCode == 39) rightPressed = false;
		else if(e.keyCode == 37) leftPressed = false;
		else if(e.keyCode == 38) upPressed = false;
		else if(e.keyCode == 40) downPressed = false;
		else if(e.keyCode == 32) fire = false;
		else if(e.keyCode == 80) pause=!pause;
	}
	
	function spawn_buff(possibility,kind){
		if(!(n = Math.floor(Math.random() * 20)%5) || possibility){
			if(kind == 1)Bullets[1][Bullets[1].length] = { x: IcanFly.x, y: 5, d: 10, c: "#FFFF44", buff: 1};
			else if(kind == 2)Bullets[1][Bullets[1].length] = { x: IcanFly.x, y: 5, d: 10, c: "#5500FF", buff: 2};
		}
		//console.log("Buff!");
	}
	
	function drawBullet() {
		var speed1 = 2;//1
		var speed2 = 4;//2

		for(l=0; l<2; l++){
			for(r=0; r<Bullets[l].length; r++) {
				if(Bullets[l][r].x>0 && Bullets[l][r].x<canvas.width+200 && Bullets[l][r].y>-200 && Bullets[l][r].y<canvas.height){
					ctx.beginPath();
					ctx.lineWidth = 3;
					switch(Bullets[l][r].d){
						case 0:
							ctx.moveTo(Bullets[l][r].x, Bullets[l][r].y);
							ctx.lineTo(Bullets[l][r].x, Bullets[l][r].y+6);
							Bullets[l][r].y -= speed2;
							break;
						case 1:
							ctx.moveTo(Bullets[l][r].x, Bullets[l][r].y);
							ctx.lineTo(Bullets[l][r].x-4, Bullets[l][r].y+4);
							Bullets[l][r].y -= speed1;
							Bullets[l][r].x += speed1;
							break;
						case 2:
							ctx.moveTo(Bullets[l][r].x, Bullets[l][r].y);
							ctx.lineTo(Bullets[l][r].x-6, Bullets[l][r].y);
							Bullets[l][r].x += speed2;
							break;
						case 3:
							ctx.moveTo(Bullets[l][r].x, Bullets[l][r].y);
							ctx.lineTo(Bullets[l][r].x-4, Bullets[l][r].y-4);
							Bullets[l][r].y += speed1;
							Bullets[l][r].x += speed1;
							break;
						case 4:
							ctx.moveTo(Bullets[l][r].x, Bullets[l][r].y);
							ctx.lineTo(Bullets[l][r].x, Bullets[l][r].y-6);
							Bullets[l][r].y += speed2;
							break;
						case 5:
							ctx.moveTo(Bullets[l][r].x, Bullets[l][r].y);
							ctx.lineTo(Bullets[l][r].x+4, Bullets[l][r].y-4);
							Bullets[l][r].y += speed1;
							Bullets[l][r].x -= speed1;
							break;
						case 6:
							ctx.moveTo(Bullets[l][r].x, Bullets[l][r].y);
							ctx.lineTo(Bullets[l][r].x+6, Bullets[l][r].y);
							Bullets[l][r].x -= speed2;
							break;
						case 7:
							ctx.moveTo(Bullets[l][r].x, Bullets[l][r].y);
							ctx.lineTo(Bullets[l][r].x+4, Bullets[l][r].y+4);
							Bullets[l][r].y -= speed1;
							Bullets[l][r].x -= speed1;
							break;
						case 8://keep chasing for a while
							ctx.arc(Bullets[l][r].x, Bullets[l][r].y, 1, 0, 2*Math.PI);
							var x=IcanFly.x-Bullets[l][r].x;
							var y=IcanFly.y-Bullets[l][r].y+IcanFly.plane_w/2;
							if(x>-200 && x<200 && y>-200 && y<200) Bullets[l][r].chase = false;
							if(Bullets[l][r].chase) {
								var c = Math.sqrt(x*x + y*y);
								x /= c; x *= 4;
								y /= c; y *= 4;
								Bullets[l][r].dy = y;
								Bullets[l][r].dx = x;
							}
							Bullets[l][r].y += Bullets[l][r].dy;
							Bullets[l][r].x += Bullets[l][r].dx;
							break;
						case 9://pre-calculated chase
							ctx.arc(Bullets[l][r].x, Bullets[l][r].y, 1, 0, 2*Math.PI);
							Bullets[l][r].y += Bullets[l][r].dy;
							Bullets[l][r].x += Bullets[l][r].dx;
							break;
						case 10://super_buff
							ctx.arc(Bullets[l][r].x, Bullets[l][r].y, 5, 0, 2*Math.PI);
							Bullets[l][r].y += Bullets[l][r].kind*2+Bullets[l][r].kind;
							break;
						default:
							/*ctx.arc(Bullets[l][r].x, Bullets[l][r].y, 1, 0, 2*Math.PI);		
							Bullets[l][r].y += Bullets[l][r].dy;
							//Bullets[l][r].x = Bullets[l][r].x>IcanFly.x?Bullets[l][r].x-1 : Bullets[l][r].x+1 ;
							if(Bullets[l][r].x>IcanFly.x-30&&Bullets[l][r].x<IcanFly.x+30){
								
								var tell = Bullets[l][r].x>IcanFly.x;
								
								console.log("hi:"+Bullets[l][r].dx);
								Bullets[l][r].x = tell?Bullets[l][r].x+Bullets[l][r].dx : Bullets[l][r].x+Bullets[l][r].dx ;
								if(Bullets[l][r].dy<0){								
									if(Bullets[l][r].y>IcanFly.y)Bullets[l][r].dx*=-1;
									
								}
								else{
									if(Bullets[l][r].y<IcanFly.y)Bullets[l][r].dx*=-1;
									
								}
								//if(Bullets[l][r].x>IcanFly.x){Bullets[l][r].dx=Bullets[l][r].dx?}
								
							}
							else{
								Bullets[l][r].x+=Bullets[l][r].dx;
							}*/
							break;
					}
					ctx.strokeStyle = Bullets[l][r].c;
					ctx.stroke();
					ctx.closePath();
				}
				else {
					Bullets[l].splice(r,1);
				}
			}
		}
		bullet_ctr ++;
	}
	
	function drawPlane_Triangle(x,y,w,speed,color) {
		ctx.beginPath();
		ctx.moveTo(x-w/2+1,y);
		ctx.lineTo(x,y+w/4);
		ctx.lineTo(x+w/2-1,y);
		ctx.lineTo(x+2,y+w*3/4);
		ctx.lineTo(x+2,y+w);
		ctx.lineTo(x-2,y+w);
		ctx.lineTo(x-2,y+w*3/4);
		ctx.moveTo(x-w/2,y);
		ctx.lineTo(x-w/2,y+w/2);
		ctx.lineTo(x-w/2+2,y+w/2);
		ctx.lineTo(x-w/2+2,y);
		ctx.moveTo(x+w/2,y);
		ctx.lineTo(x+w/2,y+w/2);
		ctx.lineTo(x+w/2-2,y+w/2);
		ctx.lineTo(x+w/2-2,y);
		ctx.fillStyle  = color;
		ctx.fill();
		ctx.closePath();
		if(!(bullet_ctr % (cycle*speed))){
			Bullets[1][Bullets[1].length] = { x: x, y: y+w+1,d: 4 ,c: color};
		}
	}
	
	function drawPlane_Round(x,y,w,speed,color) {
		var appear1 = w*3/2;
		var appear2 = w;
		ctx.beginPath();
		ctx.lineWidth = 2;
		ctx.arc(x, y, w, 0, 2*Math.PI);
		ctx.strokeStyle = color;
		ctx.stroke();
		ctx.closePath();
		ctx.beginPath();
		ctx.arc(x, y, w/2, 0, 2*Math.PI);
		ctx.strokeStyle = color;
		ctx.stroke();
		ctx.closePath();
		if(!(bullet_ctr % (cycle*speed))){
			Bullets[1][Bullets[1].length] = { x: x, y: y-appear1, d: 0 ,c: color};
			Bullets[1][Bullets[1].length] = { x: x+appear2, y: y-appear2, d: 1 ,c: color};
			Bullets[1][Bullets[1].length] = { x: x+appear1, y: y, d: 2 ,c: color};
			Bullets[1][Bullets[1].length] = { x: x+appear2, y: y+appear2, d: 3 ,c: color};
			Bullets[1][Bullets[1].length] = { x: x, y: y+appear1, d: 4 ,c: color};
			Bullets[1][Bullets[1].length] = { x: x-appear2, y: y+appear2, d: 5 ,c: color};
			Bullets[1][Bullets[1].length] = { x: x-appear1, y: y, d: 6 ,c: color};
			Bullets[1][Bullets[1].length] = { x: x-appear2, y: y-appear2, d: 7 ,c: color};
		}
	}
	
	function drawPlane_Octagon(x,y,w,speed,color) {
		ctx.beginPath();
		ctx.moveTo(x-w,y);
		ctx.lineTo(x,y-w); ctx.lineTo(x+w,y); ctx.lineTo(x,y+w);
		ctx.closePath();
		ctx.strokeStyle = color;
		ctx.stroke();
		var w2 = w/1.4;
		ctx.beginPath();
		ctx.lineWidth = 1.5;
		ctx.moveTo(x-w2,y-w2); ctx.lineTo(x+w2,y-w2); ctx.lineTo(x+w2,y+w2); ctx.lineTo(x-w2,y+w2);
		ctx.closePath();
		ctx.strokeStyle = color;
		ctx.stroke();
		if(!(bullet_ctr % (cycle*speed))){
			Bullets[1][Bullets[1].length] = { x: x, y: y-w+2, d: 0 ,c: color};
			Bullets[1][Bullets[1].length] = { x: x+w-2, y: y, d: 2 ,c: color};
			Bullets[1][Bullets[1].length] = { x: x, y: y+w-2, d: 4 ,c: color};
			Bullets[1][Bullets[1].length] = { x: x-w+2, y: y, d: 6 ,c: color};
		}
	}
	
	function drawMyPlane(speed) {
		var x=IcanFly.x;
		var y=IcanFly.y;
		var plane_w=IcanFly.plane_w;
		ctx.beginPath();
		ctx.lineWidth = 2;
		ctx.moveTo(x-plane_w/2,y+plane_w);
		ctx.lineTo(x-2,y+plane_w*3/4); ctx.lineTo(x,y+plane_w/2); ctx.lineTo(x+2,y+plane_w*3/4);
		ctx.lineTo(x+plane_w/2,y+plane_w); ctx.lineTo(x+2,y+plane_w/4); ctx.lineTo(x+2,y);
		ctx.lineTo(x-2,y); ctx.lineTo(x-2,y+plane_w/4);
		if(SuperPower == 1) ctx.fillStyle  = "#FFFF44";
		else if(SuperPower == 2) ctx.fillStyle  = "#5500FF";
		else ctx.fillStyle  = "#FFFFFF";
		ctx.fill();
		ctx.closePath();
		if(SuperPower_ctr && enemies.length) SuperPower_ctr --;
		if(!SuperPower_ctr) SuperPower = 0;
		if(!(bullet_ctr % cycle*speed) && fire){
			if(SuperPower == 1){
				Bullets[0][Bullets[0].length] = { x: x+plane_w/2, y: y+10, d: 0 ,c: "#FFFF44"};
				Bullets[0][Bullets[0].length] = { x: x-plane_w/2, y: y+10, d: 0 ,c: "#FFFF44"};
				Bullets[0][Bullets[0].length] = { x: x, y: y-1, d: 0 ,c: "#FFFF44"};
			}
			else if(SuperPower == 2){
				Bullets[0][Bullets[0].length] = { x: x+plane_w/2, y: y+10, d: 0 ,c: "#5500FF"};
				Bullets[0][Bullets[0].length] = { x: x-plane_w/2, y: y+10, d: 0 ,c: "#5500FF"};
				Bullets[0][Bullets[0].length] = { x: x, y: y-1, d: 0 ,c: "#5500FF"};
				Bullets[0][Bullets[0].length] = { x: x, y: y, d: 1 ,c: "#5500FF"};
				Bullets[0][Bullets[0].length] = { x: x, y: y, d: 3 ,c: "#5500FF"};
				Bullets[0][Bullets[0].length] = { x: x, y: y, d: 5 ,c: "#5500FF"};
				Bullets[0][Bullets[0].length] = { x: x, y: y, d: 7 ,c: "#5500FF"};
			}
			else Bullets[0][Bullets[0].length] = { x: x, y: y-1, d: 0 ,c: "#FFFFFF"};
		}
	}	
	
	function bossshoot(mode,bx,by,bw,bcolor,bspeed){
		var appear1 = 5*3/2;
		var appear2 = 5;
		switch(mode){
		case 0:
			if(!(bullet_ctr % (25*bspeed))){
				var x=IcanFly.x-bx;
				var y=IcanFly.y-by;
				var c = Math.sqrt(x*x + y*y);
				x /= c; x *= 5;
				y /= c; y *= 5;
				Bullets[1][Bullets[1].length] = { x: bx, y: by+32, d: 8, c: "#66FF66", dx: x, dy: y, chase: true};
				Bullets[1][Bullets[1].length] = { x: bx+29, y: by+15, d: 9, c: bcolor, dx: x, dy: y};
				Bullets[1][Bullets[1].length] = { x: bx-29, y: by+15, d: 9, c: bcolor, dx: x, dy: y};
				//Bullets[1][Bullets[1].length] = { x: bx+bw/2, y: by, d: 8 ,c: bcolor, dx:tmp.x, dy:tmp.y};	
				//Bullets[1][Bullets[1].length] = { x: bx-bw/2, y: by, d: 8 ,c: bcolor, dx:tmp.x, dy:tmp.y};			
			}
			if(!(bullet_ctr % (10*bspeed))){
				Bullets[1][Bullets[1].length] = { x: bx-13, y: by+28, d: 4, c: "#FF3333", dx: x, dy: y};
				Bullets[1][Bullets[1].length] = { x: bx+13, y: by+28, d: 4, c: "#FF3333", dx: x, dy: y};
			}
			break;
		case 1:
			if(!(bullet_ctr % (15*bspeed))){
			
			}
			break;
		}
		
	
	}
	
	function drawBoss(bx,by,bw,bspeed,bcolor,index){
		ctx.strokeStyle = bcolor;
		ctx.lineWidth = 4;
		ctx.beginPath();
			ctx.moveTo(bx-10,by); ctx.lineTo(bx-50,by-5); ctx.lineTo(bx-58,by-21);
			ctx.stroke();
			ctx.moveTo(bx+10,by); ctx.lineTo(bx+50,by-5); ctx.lineTo(bx+58,by-21); 
			ctx.stroke();
			ctx.moveTo(bx-32,by-3); ctx.lineTo(bx-35,by-15); 
			ctx.stroke();
			ctx.moveTo(bx+32,by-3); ctx.lineTo(bx+35,by-15); 
			ctx.stroke();
			ctx.moveTo(bx-32,by-3); ctx.lineTo(bx-29,by+15); 
			ctx.stroke();
			ctx.moveTo(bx+32,by-3); ctx.lineTo(bx+29,by+15); 
			ctx.stroke();
			ctx.moveTo(bx-32,by+3); ctx.lineTo(bx-15,by+10); ctx.lineTo(bx-13,by+28); 
			ctx.stroke();
			ctx.moveTo(bx+32,by+3); ctx.lineTo(bx+15,by+10); ctx.lineTo(bx+13,by+28); 
			ctx.stroke();
			ctx.moveTo(bx-10,by); ctx.lineTo(bx-15,by-8); ctx.lineTo(bx-28,by-10);  ctx.lineTo(bx-32,by-25); 
			ctx.stroke();
			ctx.moveTo(bx+10,by); ctx.lineTo(bx+15,by-8); ctx.lineTo(bx+28,by-10);  ctx.lineTo(bx+32,by-25); 
			ctx.stroke();
			ctx.moveTo(bx-8,by+9); ctx.lineTo(bx-8,by+20); 
			ctx.stroke();
			ctx.moveTo(bx+8,by+9); ctx.lineTo(bx+8,by+20); 
			ctx.stroke();
			ctx.moveTo(bx,by+10); ctx.lineTo(bx,by+32); 
			ctx.stroke();
		ctx.closePath();
		ctx.beginPath();
			ctx.lineWidth = 2;
			ctx.arc(bx, by, bw+2, 0, 2*Math.PI);
			ctx.strokeStyle = bcolor;
			ctx.stroke();
		ctx.closePath();
		ctx.strokeStyle = "#5555ff";
		ctx.lineWidth = 1;
		ctx.beginPath();
			ctx.moveTo(bx-10,by); ctx.lineTo(bx-50,by-5); ctx.lineTo(bx-58,by-21);
			ctx.stroke();
			ctx.moveTo(bx+10,by); ctx.lineTo(bx+50,by-5); ctx.lineTo(bx+58,by-21); 
			ctx.stroke();
			ctx.moveTo(bx-32,by-3); ctx.lineTo(bx-35,by-15); 
			ctx.stroke();
			ctx.moveTo(bx+32,by-3); ctx.lineTo(bx+35,by-15); 
			ctx.stroke();
			ctx.moveTo(bx-32,by-3); ctx.lineTo(bx-29,by+15); 
			ctx.stroke();
			ctx.moveTo(bx+32,by-3); ctx.lineTo(bx+29,by+15); 
			ctx.stroke();
			ctx.moveTo(bx-32,by+3); ctx.lineTo(bx-15,by+10); ctx.lineTo(bx-13,by+28); 
			ctx.stroke();
			ctx.moveTo(bx+32,by+3); ctx.lineTo(bx+15,by+10); ctx.lineTo(bx+13,by+28); 
			ctx.stroke();
			ctx.moveTo(bx-10,by); ctx.lineTo(bx-15,by-8); ctx.lineTo(bx-28,by-10);  ctx.lineTo(bx-32,by-25); 
			ctx.stroke();
			ctx.moveTo(bx+10,by); ctx.lineTo(bx+15,by-8); ctx.lineTo(bx+28,by-10);  ctx.lineTo(bx+32,by-25); 
			ctx.stroke();
			ctx.moveTo(bx-8,by+9); ctx.lineTo(bx-8,by+20); 
			ctx.stroke();
			ctx.moveTo(bx+8,by+9); ctx.lineTo(bx+8,by+20); 
			ctx.stroke();
			ctx.moveTo(bx,by+10); ctx.lineTo(bx,by+32); 
			ctx.stroke();
		ctx.closePath();
		if(boss_mode<512){
			bcolor = "#ff0000";
			enemies[index].inv=false;
			if(enemies[index].blood<10){
				bossshoot(0,bx,by,bw,bcolor,bspeed);
			}
			else {
				bossshoot(0,bx,by,bw,bcolor,bspeed);
			}
			boss_mode++;
		}
		else if(boss_mode==512){
			enemies[index].inv=true;
			if(enemies[index].blood<=10){
				enemies[enemies.length] = {x: 380, y: 120, w: 20, dx: -5, dy: 3, t: 0, speed: 2, color: "#99BBFF",
					x_upper_limit: 400, x_lower_limit: 160, y_upper_limit: 150, y_lower_limit: 0};
				enemies[enemies.length] = {x: 20, y: 120, w: 20, dx: 5, dy: 3, t: 0, speed: 2, color: "#99BBFF",
					x_upper_limit: 240, x_lower_limit: 0, y_upper_limit: 150, y_lower_limit: 0};
				enemies[enemies.length] = {x: 380, y: 120, w: 10, dx: -6, dy: 3, t: 1, speed: 1, color: "#99BBFF",
					x_upper_limit: 500, x_lower_limit: 50, y_upper_limit: 700, y_lower_limit: -100};
				enemies[enemies.length] = {x: 20, y: 120, w: 10, dx: 6, dy: 3, t: 1, speed: 1, color: "#99BBFF",
					x_upper_limit: 350, x_lower_limit: -100, y_upper_limit: 700, y_lower_limit: -100};
				enemies[enemies.length] = {x: 380, y: 600, w: 10, dx: -6, dy: -3, t: 1, speed: 1, color: "#99BBFF",
					x_upper_limit: 500, x_lower_limit: 50, y_upper_limit: 700, y_lower_limit: -100};
				enemies[enemies.length] = {x: 20, y: 600, w: 10, dx: 6, dy: -3, t: 1, speed: 1, color: "#99BBFF",
					x_upper_limit: 350, x_lower_limit: -100, y_upper_limit: 700, y_lower_limit: -100};
			}
			else {
				//bossshoot(1,bx,by,bw,bcolor,bspeed);
				enemies[enemies.length] = {x: 380, y: 120, w: 20, dx: -5, dy: 3, t: 0, speed: 2, color: "#99BBFF",
					x_upper_limit: 400, x_lower_limit: 160, y_upper_limit: 150, y_lower_limit: 0};
				enemies[enemies.length] = {x: 20, y: 120, w: 20, dx: 5, dy: 3, t: 0, speed: 2, color: "#99BBFF",
					x_upper_limit: 240, x_lower_limit: 0, y_upper_limit: 150, y_lower_limit: 0};
				enemies[enemies.length] = {x: 180, y: 120, w: 20, dx: 5, dy: 3, t: 0, speed: 2, color: "#99BBFF",
					x_upper_limit: 400, x_lower_limit: 160, y_upper_limit: 150, y_lower_limit: 0};
				enemies[enemies.length] = {x: 220, y: 120, w: 20, dx: -5, dy: 3, t: 0, speed: 2, color: "#99BBFF",
					x_upper_limit: 240, x_lower_limit: 0, y_upper_limit: 150, y_lower_limit: 0};
			}
			boss_mode++;
		}
		else if(boss_mode == 1024 || enemies.length == 1){
			spawn_buff(true,2);
			boss_mode = 0;
		}
		else if(boss_mode<1024){
			boss_mode++;
		}
		
		if(boss_hurt>0){
			boss_hurt --;
			bcolor = "#FFB7DD";
		}
		ctx.beginPath();
		ctx.lineWidth = 3;
		ctx.arc(bx, by, bw, 0, 2*Math.PI);
		ctx.strokeStyle = bcolor;
		ctx.stroke();
		ctx.closePath();
		ctx.beginPath();
		ctx.lineWidth = 3;
		ctx.arc(bx, by, bw-6, 0, 2*Math.PI);
		ctx.strokeStyle = bcolor;
		ctx.stroke();
		ctx.closePath();
		///////draw blood
		ctx.font = "16px Arial";
		ctx.fillStyle = "#ffffff";
		ctx.fillText("BOSS :"+enemies[index].blood*5+"%", 2, 18);
		ctx.beginPath();
		for(tmp=0; tmp<enemies[index].blood; tmp++)
			ctx.rect(100+12*tmp, 6, 10, 12);
		ctx.fillStyle  = "#FF0000";
		ctx.fill();
		ctx.closePath();
	}
	
	function drawPlanes() {
		drawMyPlane(ATKspeed);
		for(i=0; i<enemies.length; i++){
			if(enemies[i].t == 0)drawPlane_Triangle(enemies[i].x,enemies[i].y,enemies[i].w,enemies[i].speed,enemies[i].color);
			if(enemies[i].t == 1)drawPlane_Round(enemies[i].x,enemies[i].y,enemies[i].w,enemies[i].speed,enemies[i].color);
			if(enemies[i].t == 2)drawBoss(enemies[i].x,enemies[i].y,enemies[i].w,enemies[i].speed,enemies[i].color,i);
			if(enemies[i].t == 3)drawPlane_Octagon(enemies[i].x,enemies[i].y,enemies[i].w,enemies[i].speed,enemies[i].color);
			
			
			if(enemies[i].x + enemies[i].dx > enemies[i].x_upper_limit-enemies[i].w/2 || enemies[i].x + enemies[i].dx < enemies[i].x_lower_limit+enemies[i].w/2) {
				enemies[i].dx = -enemies[i].dx;
			}
			if(enemies[i].y + enemies[i].dy > enemies[i].y_upper_limit || enemies[i].y + enemies[i].dy < enemies[i].y_lower_limit+enemies[i].w) {
				enemies[i].dy = -enemies[i].dy;
			}
			enemies[i].x += enemies[i].dx;
			enemies[i].y += enemies[i].dy;
		}
	}
	
	function killplane(point) {
		//console.log("kill")
		if(blood < blood_max && SuperPower)blood ++;
		score += point;
	}
	
	function collisionDetection() {
		for(c=0; c<Bullets[0].length; c++) {
			for(p=0; p<enemies.length; p++){
				if(enemies[p].t == 0){
					if((Bullets[0][c].y-enemies[p].y)<=2*(Bullets[0][c].x-enemies[p].x)+enemies[p].w &&
						(Bullets[0][c].y-enemies[p].y)<=2*(enemies[p].x-Bullets[0][c].x)+enemies[p].w &&
						Bullets[0][c].y>enemies[p].y){
						Bullets[0].splice(c,1);
						enemies.splice(p,1);
						killplane(10);
						if(SuperPower) SuperPower_ctr+=10;
					}
					
				}
				else if(enemies[p].t == 1 || enemies[p].t == 3){
					if((Bullets[0][c].y-enemies[p].y) * (Bullets[0][c].y-enemies[p].y) + (Bullets[0][c].x-enemies[p].x) * (Bullets[0][c].x-enemies[p].x) <= enemies[p].w * enemies[p].w){
						Bullets[0].splice(c,1);
						spawn_buff(false,1);
						enemies.splice(p,1);
						killplane(25);
						if(SuperPower) SuperPower_ctr+=25;
					}
				}
				else if(enemies[p].t == 2 && !(enemies[p].inv)){
					if((Bullets[0][c].y-enemies[p].y) * (Bullets[0][c].y-enemies[p].y) + (Bullets[0][c].x-enemies[p].x) * (Bullets[0][c].x-enemies[p].x) <= enemies[p].w * enemies[p].w){
						Bullets[0].splice(c,1);
						enemies[p].blood --;
						boss_hurt = 20;
						if(enemies[p].blood<=0){
							spawn_buff(false,1);
							enemies.splice(p,1);
							killplane(150);
							if(SuperPower) SuperPower_ctr+=150;
						}
					}
				}
			}
		}
		for(c=0; c<Bullets[1].length; c++) {
			if((Bullets[1][c].y-IcanFly.y)>=2*(Bullets[1][c].x-IcanFly.x) &&
				(Bullets[1][c].y-IcanFly.y)>=2*(IcanFly.x-Bullets[1][c].x) &&
				Bullets[1][c].y<IcanFly.y+IcanFly.plane_w){
				if(Bullets[1][c].d != 10){
					//console.log("injured");
					if(SuperPower){
						SuperPower_ctr -= 30;
					}
					else{
					if(blood > 1) blood --;
						else if(life > 0){
							life --;
							blood = blood_max;
						}
						else {
							alert("Game Over!!\nYour score is "+score+"!");
							document.location.reload();
						}
					}
				}
				else {
					//console.log("Buff_activated");
					if(SuperPower == 1 && Bullets[1][c].buff == 2){
					SuperPower = Bullets[1][c].buff;
					SuperPower_ctr = 1000;
					}
					else if(SuperPower == 2 && Bullets[1][c].buff == 1){
					SuperPower_ctr += 300;
					}
					else if(!SuperPower){
					SuperPower = Bullets[1][c].buff;
					SuperPower_ctr += Bullets[1][c].buff*500;
					}
					else if(SuperPower == Bullets[1][c].buff){
					SuperPower = Bullets[1][c].buff;
					SuperPower_ctr += Bullets[1][c].buff*250;
					}
				}
				Bullets[1].splice(c,1);
			}
		}
	}
	
	function drawScore() {
		ctx2.font = "16px Arial";
		ctx2.fillStyle = "#ffffff";
		ctx2.fillText("Score: "+score, 10, 20);
		ctx2.fillText("life: "+life, 10, 35);
		ctx2.fillText("blood[ ", 10, 50);
		for(i = 0; i < blood; i++) 
			ctx2.fillText("|", 60+5*i, 50);
		ctx2.fillText("] : "+blood*100/blood_max+"%", 65+5*blood_max, 50);
		ctx2.font = "30px Arial";
		if(SuperPower == 1) ctx2.fillStyle  = "#FFFF44";
		else if(SuperPower == 2) ctx2.fillStyle  = "#5500FF";
		ctx2.fillText("Super: "+SuperPower_ctr, 170, 30);
	}
	
	function draw() {
		if(pause)return;
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
		if(!(enemies.length)){
			Bullets[0] = [];
			Bullets[1] = [];
			level_ctr ++;
			if(level_ctr<level_refresh-50){
				ctx.font = "25px Arial";
				if(level_text == "Final" || level_text == "Ready"){
					ctx.fillStyle = "#ff0000";
					ctx.fillText(level_text, 165, 300);
				}
				else {
					ctx.fillStyle = "#ffffff";
					ctx.fillText("Level "+level_text, 145, 300);
				}
			}
		}
		if(level_ctr == level_refresh) {
			level_ctr = 0;
			load_level();
			level_flag ++;
		}
		drawBullet();
		drawPlanes();
		collisionDetection();
		drawScore();

		if(rightPressed && IcanFly.x < canvas.width-IcanFly.plane_w/2) IcanFly.x += movespeed;
		if(leftPressed && IcanFly.x > IcanFly.plane_w/2) IcanFly.x -= movespeed;
		if(upPressed && IcanFly.y > 150) IcanFly.y -= movespeed;
		if(downPressed && IcanFly.y < canvas.height-IcanFly.plane_w-2) IcanFly.y += movespeed;
	}
	setInterval(draw, 10);
</script>

</body>
</html>